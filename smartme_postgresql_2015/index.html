<!DOCTYPE html>
<html>
<head>
  <title>PostgreSQL: tuning and scaling - SmartMe 2015</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">-->
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
  <!--This one seems to work all the time, but really small on ipad-->
  <!--<meta name="viewport" content="initial-scale=0.4">-->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" media="all" href="theme/css/default.css">
  <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="theme/css/phone.css">
  <base target="_blank"> <!-- This amazingness opens all links in a new tab. -->
  <script data-main="js/slides" src="js/require-1.0.8.min.js"></script>
</head>
<body style="opacity: 0">

<slides class="layout-widescreen">

  <slide class="logoslide nobackground">
    <article class="flexbox vcenter">
      <span><img src="images/title.png"></span>
    </article>
  </slide>

  <slide class="title-slide segue nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
    <hgroup class="auto-fadein">
      <h1 data-config-title><!-- populated from slide_config.json --></h1>
      <h2 data-config-subtitle><!-- populated from slide_config.json --></h2>
      <p data-config-presenter><!-- populated from slide_config.json --></p>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Alexey Vasiliev</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/photo.jpg" alt="me" style="height: 525px" />
        </div>
        <ul>
          <li>8+ years experience
            <ul>
              <li>Linux and Databases administrator</li>
              <li>Web and Mobile developer (Ruby, Java, JavaScript, Objective-C, C/C++)</li>
            </ul>
          </li>
          <li>Open-Source developer
            <ul>
              <li><a href="http://pgtune.leopard.in.ua/">PgTune</a>, <a href="http://sql-joins.leopard.in.ua/">SQL Joins Visualizer</a></li>
              <li>RWbox, ElixirV8, Go-kinesis</li>
              <li>WebP-ffi, Zopfli-ffi</li>
              <li>MongodbLogger for Rails</li>
              <li>Piro - Chrome extension for PivotalTracker</li>
              <li>SMTRails and SHTRails (shared templates for rails)</li>
            </ul>
          </li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>My books</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/pg_book_cover.png" alt="Pg book" style="height: 500px" />
        </div>
        <div class="centered">
          <img src="images/chef_book_cover.png" alt="Chef book" style="height: 500px" />
        </div>
      </div>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>SQL and NoSQL</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Relational database management system</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <p>Edgar Codd is the author of the 'relational' concept</p>
          <ul>
            <li>each element of the table is a data element;</li>
            <li>all cells in the column homogeneous: all elements in the column are the same type (numeric, character, etc.);</li>
            <li>each column has a unique name;</li>
            <li>identical rows in the table are not available;</li>
            <li>the order of the rows and columns can be arbitrary.</li>
          </ul>
        </div>
        <div class="centered">
          <img src="images/Edgar_F_Codd.jpg" alt="Edgar_F_Codd" style="height: 500px" />
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>NoSQL</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <p>For the first time the term "NoSQL" was used in the late 90's. The real meaning of the form used now got only in the middle 2009. Originally, it was a title of the open-source database created by Carlo Strozzi, which stores all data as ASCII files and used shell scripts instead of SQL to access data.</p>
          <p>The term "NoSQL" has absolutely natural origin and has no universally accepted definition or scientific institution behind. This title is rather characterized by the vector of development of IT away from relational databases</p>
        </div>
        <div class="centered">
          <img src="images/carlo-strozzi.jpg" alt="carlo-strozzi" style="height: 500px" />
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Wide Column Store / Column Families</h2>
      <h3>NoSQL</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <h3>Advantages</h3>
          <ul>
            <li>It is possible to compress data significantly, because in a single column of the table, the data is usually in the same type;</li>
            <li>Allows on a cheap and low-powered hardware to boost the speed for the query performance in the 5, 10 and sometimes even 100 times, thus, due to compression, the data on the drive will take 5-10 times less space than in the case of the traditional RDBMS</li>
          </ul>
        </div>
        <div>
          <h3>Disadvantages</h3>
          <ul>
            <li>In general there are no transactions;</li>
            <li>Have a number of limitations for the developer who is used to the developed traditional RDBMS</li>
          </ul>
          <br /><br /><br /><br /><br />
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Key Value / Tuple Store</h2>
      <h3>NoSQL</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <h3>Advantages</h3>
          <ul>
            <li>RDBMS are too slow, have heavy layer of SQL cursors;</li>
            <li>Solutions of RDBMS to store small amounts of data too much cost;</li>
            <li>There are no need for SQL queries, indexes, triggers, stored procedures, temporary tables, forms, views, etc;</li>
            <li>Key/value database is easily scalable and high-performance due to its lightness.</li>
          </ul>
        </div>
        <div>
          <h3>Disadvantages</h3>
          <ul>
            <li>Limitations of relational databases ensure data integrity at the lowest level. In stores key/value no such restriction. Data integrity controled by applications. In this case data integrity may be compromised due to errors in the application code;</li>
            <li>In an RDBMS if the model is well designed, the database will contain a logical structure that fully reflects the structure of the stored data. For a key/value storage it is harder to achieve.</li>
          </ul>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Document Store</h2>
      <h3>NoSQL</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <h3>Advantages</h3>
          <ul>
            <li>Sufficiently flexible language for querying;</li>
            <li>Easy horizontally scalable.</li>
          </ul>
        </div>
        <div>
          <h3>Disadvantages</h3>
          <ul>
            <li>Atomicity in most cases is conditional.</li>
          </ul>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Graph Databases</h2>
      <h3>NoSQL</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <h3>Advantages</h3>
          <ul>
            <li>Often faster for associative data sets;</li>
            <li>Can scale more naturally to large data sets as they do not typically require expensive join operations.</li>
          </ul>
        </div>
        <div>
          <h3>Disadvantages</h3>
          <ul>
            <li>RDBMS can be used in more general cases. Graph databases are suitable for graph-like data.</li>
          </ul>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Object Databases</h2>
      <h3>NoSQL</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <h3>Advantages</h3>
          <ul>
            <li>The object model is the best display of the real world, rather than relational tuples. This is especially true for complex and multi-faceted objects;</li>
            <li>Organize your data with hierarchical characteristics;</li>
            <li>Separate query language is not required for accessing the data, because access is directly to objects. Nevertheless, the possibility exists to use the queries.</li>
          </ul>
        </div>
        <div>
          <h3>Disadvantages</h3>
          <ul>
            <li>In the RDBMS schema change as a result of the creation, modification or deletion of tables usually do not depend on the application;</li>
            <li>Object database usually tied to a particular language with a separate API and data are available only through the API. RDBMS in this regard is a great opportunity, thanks to the common query language.</li>
          </ul>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>... and many others</h2>
      <h3>NoSQL</h3>
    </hgroup>
    <article>
      <div class="centered">
        <h3>Now there are about <a href="http://nosql-database.org/">150 kinds of NoSQL databases</a></h3>
        <img src="images/nosql-logos.png" alt="nosql" />
      </div>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>What is PostgreSQL?</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>PostgreSQL</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/postgresql_logo.png" alt="Pg logo" style="height: 450px" />
        </div>
        <div>
          <p><b>PostgreSQL ("Postgres")</b> - is an object-relational database management system (ORDBMS) with an emphasis on extensibility and standards-compliance</p>
          <p>PostgreSQL is based on the SQL language and supports many of the features of the standard SQL:2011</p>
          <p>PostgreSQL evolved from the Ingres project at the University of California, Berkeley. In 1982 the leader of the Ingres team, Michael Stonebraker, left Berkeley to make a proprietary version of Ingres. He returned to Berkeley in 1985 and started a post-Ingres project.</p>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>PostgreSQL strengths</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <ul>
            <li>database support of virtually unlimited size;</li>
            <li>powerful and reliable transaction and replication mechanisms;</li>
            <li>extensible embedded programming languages: in the standard package are supported by PL/pgSQL, PL/Perl, PL/Python and PL/Tcl; additionally, you can use PL/Java, PL/PHP, PL/Py, PL/R, PL/Ruby, PL/Scheme, PL/sh and PL/V8, and has support for loading C-compatible modules;</li>
            <li>inheritance;</li>
            <li>easy extensibility.</li>
          </ul>
        </div>
        <div class="centered">
          <img src="images/title.png" alt="Pg logo" style="height: 450px" />
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>PostgreSQL limits</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <table>
            <tbody>
              <tr>
                <th>Limit</th>
                <th>Value</th>
              </tr>
              <tr>
                <td>Maximum Database Size</td>
                <td>Unlimited</td>
              </tr>
              <tr>
                <td>Maximum Table Size</td>
                <td>32 TB</td>
              </tr>
              <tr>
                <td>Maximum Row Size</td>
                <td>1.6 TB</td>
              </tr>
              <tr>
                <td>Maximum Field Size</td>
                <td>1 GB</td>
              </tr>
              <tr>
                <td>Maximum Rows per Table</td>
                <td>Unlimited</td>
              </tr>
              <tr>
                <td>Maximum Columns per Table</td>
                <td>250-1600 depending on column types</td>
              </tr>
              <tr>
                <td>Maximum Indexes per Table</td>
                <td>Unlimited</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="centered">
          <img src="images/limits.png" alt="Limits" style="height: 514px" />
        </div>
      </div>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>PostgreSQL features</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>SQL:2011 standard</h2>
    </hgroup>
    <article class="smaller">
      <pre class="prettyprint" data-lang="sql">
  mysql> SELECT 124124/0;
  +----------+
  | 124124/0 |
  +----------+
  |     NULL |
  +----------+
      </pre>
      <pre class="prettyprint" data-lang="sql">
  mysql> (SELECT * FROM moo LIMIT 1) LIMIT 2;
  +------+
  | a    |
  +------+
  |    1 |
  |    2 |
  +------+
      </pre>
      <pre class="prettyprint" data-lang="sql">
  mysql> SELECT 'aaa' = 'aaa ';
  +----------------+
  | 'aaa' = 'aaa ' |
  +----------------+
  |              1 |
  +----------------+
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>SQL:2011 standard</h2>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
  mysql> CREATE TABLE enums(a ENUM('c', 'a', 'b'), b INT, KEY(a));
  mysql> INSERT INTO enums VALUES('a', 1), ('b', 1), ('c', 1);
  mysql> SELECT MIN(a), MAX(a) FROM enums;
  +--------+--------+
  | MIN(a) | MAX(a) |
  +--------+--------+
  | c      | b      |
  +--------+--------+
  mysql> SELECT MIN(a), MAX(a) FROM enums WHERE b = 1;
  +--------+--------+
  | MIN(a) | MAX(a) |
  +--------+--------+
  | a      | c      |
  +--------+--------+
      </pre>
    </article>
  </slide>



  <slide>
    <hgroup>
      <h2>Flexible Datatypes</h2>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/datatypes.png" alt="PostgreSQL" style="width: 600px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Flexible Datatypes</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <h3>Build in:</h3>
        <ul>
          <li>integer, (small|big)int, decimal, numeric, real</li>
          <li>money, serial, (small|big)serial</li>
          <li>character(n), char(n), text, bytea</li>
          <li>timestamp (with/without time zone), date, time, interval</li>
          <li>boolean, enum</li>
          <li>point, line, box, path, polygon, circle</li>
          <li>cidr, inet, macaddr</li>
          <li>tsvector, uuid</li>
          <li>xml, json, jsonb, arrays</li>
          <li>(int4|int8|num|ts|tstz|date)range</li>
        </ul>
        <h3>With extensions:</h3>
        <ul>
          <li>box2d, box3d, geometry, geometry_dump, geography</li>
          <li>spoint, strans, scircle, sline, sellipse, spoly, spath, sbox</li>
          <li>image, hstore, prefix_range</li>
          <li>semver, mpz, mpq</li>
          <li>many others...</li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Arrays</h2>
      <h3>Flexible Datatypes</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        select <b>array_agg(id)</b> from endpoints <b>group by application_id</b>;
      </pre>
      <pre class="prettyprint" data-lang="sql">
        select (array['hi', 'there', 'everyone', 'at', 'smartme'])[random()*2 + 1];
      </pre>
      <pre class="prettyprint" data-lang="sql">
        select name, tags from posts where <b>tags @> array['it', 'sql']</b>;
      </pre>
      <pre class="prettyprint" data-lang="sql">
        select <b>unnest(tags)</b> as tag from posts where title = 'About PostgreSQL';
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Ranges (9.2+)</h2>
      <h3>Flexible Datatypes</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        SELECT int4range(10, 20) @> 3;
        SELECT daterange('["Jan 1 2013", "Jan 15 2013")') @> 'Jan 10 2013'::date;
      </pre>
      <pre class="prettyprint" data-lang="sql">
        $ ALTER TABLE reservation ADD EXCLUDE USING gist (during WITH &&);

        $ INSERT INTO reservation VALUES (1108, '[2010-01-01 11:30, 2010-01-01 13:00)');
        INSERT 0 1

        $ INSERT INTO reservation VALUES (1108, '[2010-01-01 14:45, 2010-01-01 15:45)');
        ERROR:  conflicting key value violates exclusion constraint "reservation_during_excl"
        DETAIL:  Key (during)=([ 2010-01-01 14:45:00, 2010-01-01 15:45:00 )) conflicts
        with existing key (during)=([ 2010-01-01 14:30:00, 2010-01-01 15:30:00 )).
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>XML, JSON and JSONB</h2>
      <h3>Flexible Datatypes</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        $ SELECT xpath('/my:a/text()', '<my:a xmlns:my="http://example.com">test</my:a>', ARRAY[ARRAY['my', 'http://example.com']]);
         xpath
        --------
         {test}
      </pre>
      <pre class="prettyprint" data-lang="sql">
        $ SELECT * from json_demo;
          id | username |       email       | posts_count
         ----+----------+-------------------+-------------
           1 | john     | john@gmail.com    |          10
           2 | mickael  | mickael@gmail.com |          50
         $ SELECT row_to_json(json_demo) FROM json_demo;
                                         row_to_json
         ----------------------------------------------------------------------------
          {"id":1,"username":"john","email":"john@gmail.com","posts_count":10}
          {"id":2,"username":"mickael","email":"mickael@gmail.com","posts_count":50}
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>JSON/JSONB and PLV8 for "schemaless" sql</h2>
      <h3>Flexible Datatypes</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        CREATE OR REPLACE FUNCTION get_numeric(json_raw json, key text)
        RETURNS numeric AS $$
          var o = JSON.parse(json_raw);
          return o[key];
        $$ LANGUAGE plv8 IMMUTABLE STRICT;
      </pre>
      <pre class="prettyprint" data-lang="sql">
        SELECT * FROM members WHERE get_numeric(profile, 'age') = 36;
        <b>Time: 9340.142 ms</b>
      </pre>
      <pre class="prettyprint" data-lang="sql">
        CREATE INDEX member_age ON members (get_numeric(profile, 'age'));
      </pre>
      <pre class="prettyprint" data-lang="sql">
         SELECT * FROM members WHERE get_numeric(profile, 'age') = 36;
         <b>Time: 57.429 ms</b>
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>JSON functions (9.3+)</h2>
      <h3>Flexible Datatypes</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <ul>
          <li>array_to_json (present in 9.2)</li>
          <li>row_to_json (present in 9.2)</li>
          <li>to_json</li>
          <li>json_array_length</li>
          <li>json_each</li>
          <li>json_each_text</li>
          <li>json_extract_path</li>
          <li>json_extract_path_text</li>
          <li>json_object_keys</li>
          <li>json_populate_record</li>
          <li>json_populate_recordset</li>
          <li>json_array_elements</li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>JSONB (9.4+)</h2>
      <h3>Flexible Datatypes</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        SELECT '[1, 2, 3]'::jsonb @> '[1, 3]'::jsonb;
         ?column?
        ----------
         t
        (1 row)
      </pre>
      <pre class="prettyprint" data-lang="sql">

        SELECT '{"product": "PostgreSQL", "version": 9.4, "jsonb":true}'::jsonb @> '{"version":9.4}'::jsonb;
         ?column?
        ----------
         t
        (1 row)
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>WITH examples</h2>
      <h3>WITH</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        WITH a AS ( SELECT 'a' as a ) SELECT * FROM a;
      </pre>
      <pre class="prettyprint" data-lang="sql">
        WITH
          prepared_data AS ( ... )
        SELECT data, count(data),
               min(data), max(data)
        FROM prepared_data
        GROUP BY data;
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>WITH examples</h2>
      <h3>WITH</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
      $ WITH RECURSIVE t(n) AS (
          VALUES (1)
        UNION ALL
          SELECT n+1 FROM t WHERE n < 100
        )
        SELECT sum(n) FROM t;

         sum
        ------
         5050
        (1 row)
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>LISTEN / NOTIFY example</h2>
      <h3>LISTEN / NOTIFY</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        $ <b>LISTEN delay_worker;</b>
        LISTEN
        $ <b>NOTIFY delay_worker, '44924';</b>
        NOTIFY
        Asynchronous notification "delay_worker"
        with payload "44924" received from server process with PID 29118.
        $ <b>SELECT pg_notify('delay_worker', '44924');</b>
         pg_notify
        -----------

        (1 row)

        Asynchronous notification "delay_worker"
        with payload "44924" received from server process with PID 29118.
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>What is this?</h2>
      <h3>LISTEN / NOTIFY</h3>
    </hgroup>
    <article>
      <ul>
        <li>LISTEN on a channel</li>
        <li>NOTIFY messages are delivered asynchronously w/payload</li>
        <li>useful to fan out messages to other clients</li>
      </ul>
      <h3>Great for</h3>
      <ul>
        <li>broadcasting events to other clients</li>
        <li>work distribution</li>
        <li>cache busting</li>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Window functions example</h2>
      <h3>Window functions</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        $ <b>SELECT depname, empno, salary, avg(salary)
          OVER (PARTITION BY depname) FROM empsalary;</b>
         depname  | empno | salary |          avg
        -----------+-------+--------+-----------------------
         develop   |    11 |   5200 | 5020.0000000000000000
         develop   |     7 |   4200 | 5020.0000000000000000
         develop   |     9 |   4500 | 5020.0000000000000000
         develop   |     8 |   6000 | 5020.0000000000000000
         develop   |    10 |   5200 | 5020.0000000000000000
         personnel |     5 |   3500 | 3700.0000000000000000
         personnel |     2 |   3900 | 3700.0000000000000000
         sales     |     3 |   4800 | 4866.6666666666666667
         sales     |     1 |   5000 | 4866.6666666666666667
         sales     |     4 |   4800 | 4866.6666666666666667
        (10 rows)
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Window functions example</h2>
      <h3>Window functions</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        $ <b>SELECT salary, sum(salary) OVER () FROM empsalary;</b>
         salary |  sum
        --------+-------
           5200 | 47100
           5000 | 47100
           3500 | 47100
           4800 | 47100
           3900 | 47100
           4200 | 47100
           4500 | 47100
           4800 | 47100
           6000 | 47100
           5200 | 47100
        (10 rows)
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Window functions example</h2>
      <h3>Window functions</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        $ <b>SELECT salary, sum(salary) OVER (ORDER BY salary) FROM empsalary;</b>
         salary |  sum
        --------+-------
           3500 |  3500
           3900 |  7400
           4200 | 11600
           4500 | 16100
           4800 | 25700
           4800 | 25700
           5000 | 30700
           5200 | 41100
           5200 | 41100
           6000 | 47100
        (10 rows)
      </pre>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>PostgreSQL Internals</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Backend Flowchart</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <a href="images/backend_flowchart.png">
          <img src="images/backend_flowchart.png" alt="backend_flowchart" style="height: 450px" />
        </a>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Optimizer</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <h3>Optimizer</h3>
          <ul>
            <li>Scan Methods</li>
            <li>Join Methods</li>
            <li>Join Order</li>
          </ul>
        </div>
        <div>
          <h3>Scan Methods</h3>
          <ul>
            <li>Sequential Scan</li>
            <li>Index Scan</li>
            <li>Bitmap Index Scan</li>
          </ul>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Sequential Scan</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/sequential_scan.png" alt="sequential_scan" style="height: 400px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Btree Index Scan</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/btree_index_scan.png" alt="btree_index_scan" style="height: 400px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Bitmap Index Scan</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/bitmap_index_scan.png" alt="bitmap_index_scan" style="height: 400px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Join Methods</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <ul>
        <li>
          Nested Loop
          <ul>
            <li>With Inner Sequential Scan</li>
            <li>With Inner Index Scan</li>
          </ul>
        </li>
        <li>Hash Join</li>
        <li>Merge Join</li>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Nested Loop Join with Inner Sequential Scan</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/nested_loop_join_with.png" alt="nested_loop_join_with" style="height: 400px" /><br />
        <p>Used For Small Tables</p>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Nested Loop Join with Inner Index Scan</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/nested_loop_join_with_index.png" alt="nested_loop_join_with_index" style="height: 400px" /><br />
        <p>Index Must Already Exist</p>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Hash Join</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/hash_join.png" alt="hash_join" style="height: 400px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Merge Join</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/merge_join.png" alt="merge_join" style="height: 400px" /><br />
        <p>Ideal for Large Tables, An Index Can Be Used to Eliminate the Sort</p>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Learn SQL Joins</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article>
      <div class="centered">
        <h3><a href="http://sql-joins.leopard.in.ua/">sql-joins.leopard.in.ua</a></h3>
        <img src="images/sql_joins_app.png" alt="sql_joins_app" style="height: 400px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Lock Modes</h2>
      <h3>PostgreSQL Internals</h3>
    </hgroup>
    <article class="smaller">
      <div class="centered">
        <table>
          <tbody>
            <tr>
              <th>Mode</th>
              <th>Used</th>
            </tr>
            <tr>
              <td>Access Share Lock</td>
              <td>SELECT</td>
            </tr>
            <tr>
              <td>Row Share Lock</td>
              <td>SELECT FOR UPDATE</td>
            </tr>
            <tr>
              <td>Row Exclusive Lock</td>
              <td>INSERT, UPDATE, DELETE</td>
            </tr>
            <tr>
              <td>Share Lock</td>
              <td>CREATE INDEX</td>
            </tr>
            <tr>
              <td>Share Row Exclusive Lock</td>
              <td>EXCLUSIVE MODE but allows ROW SHARE LOCK</td>
            </tr>
            <tr>
              <td>Exclusive Lock</td>
              <td>Blocks ROW SHARE LOCK and SELECT...FOR UPDATE</td>
            </tr>
            <tr>
              <td>Access Exclusive Lock</td>
              <td>ALTER TABLE, DROP TABLE, VACUUM</td>
            </tr>
            <tr>
              <td>Advisory Locks</td>
              <td>Application-defined</td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>PostgreSQL settings</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>At beginning</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <ul>
            <li>Do not use the default settings</li>
            <li>Use the latest version of a PostgreSQL server</li>
            <li>Do not rely on performance tests</li>
            <li>EXPLAIN ANALYZE and indexes, indexes, indexes</li>
          </ul>
        </div>
        <div class="centered">
          <img src="images/homer616.jpeg" alt="Homer" style="width: 350px">
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Performance since PostgreSQL 7.4</h2>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/pgbench-medium-ro-xeon.png" alt="Perf" style="height: 500px">
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Performance since PostgreSQL 7.4</h2>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/pgbench-small-ro-xeon.png" alt="Perf" style="height: 500px">
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Performance since PostgreSQL 7.4</h2>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/pgbench-large-rw-xeon.png" alt="Perf" style="height: 500px">
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>shared_buffers and work_mem</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <h3>shared_buffers</h3>
      <p>Sets the amount of memory the database server uses for shared memory buffers. Larger settings for shared_buffers usually require a corresponding increase in checkpoint_segments, in order to spread out the process of writing large quantities of new or changed data over a longer period of time.</p>
      <h3>work_mem</h3>
      <p>Specifies the amount of memory to be used by internal sort operations and hash tables before writing to temporary disk files. Note that for a complex query, several sort or hash operations might be running in parallel; each operation will be allowed to use as much memory as this value specifies before it starts to write data into temporary files.</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>shared_buffers (&lt; 9.3)</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="bash">
  #!/bin/bash
  # simple shmsetup script
  page_size=`getconf PAGE_SIZE`
  phys_pages=`getconf _PHYS_PAGES`
  shmall=`expr $phys_pages / 2`
  shmmax=`expr $shmall \* $page_size`
  echo kernel.shmmax = $shmmax
  echo kernel.shmall = $shmall
      </pre>
      <p>Example for 2GB:</p>
      <pre class="prettyprint" data-lang="bash">
  kernel.shmmax = 1055092736
  kernel.shmall = 257591
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>maintenance_work_mem and temp_buffers</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <h3>maintenance_work_mem</h3>
      <p>Specifies the maximum amount of memory to be used by maintenance operations, such as VACUUM, CREATE INDEX, and ALTER TABLE ADD FOREIGN KEY.</p>
      <h3>temp_buffers</h3>
      <p>Sets the maximum number of temporary buffers used by each database session. These are session-local buffers used only for access to temporary tables.</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>checkpoint_segments and checkpoint_completion_target</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <h3>checkpoint_segments</h3>
      <p>Maximum number of log file segments between automatic WAL checkpoints (each segment is normally 16 megabytes).</p>
      <h3>checkpoint_completion_target</h3>
      <p>Specifies the target of checkpoint completion, as a fraction of total time between checkpoints.</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>synchronous_commit and fsync</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <h3>synchronous_commit</h3>
      <p>Specifies whether transaction commit will wait for WAL records to be written to disk before the command returns a "success" indication to the client. Valid values are on, remote_write, local, and off.</p>
      <h3>fsync</h3>
      <p>If this parameter is on, the PostgreSQL server will try to make sure that updates are physically written to disk, by issuing fsync() system calls or various equivalent methods.</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>default_statistics_target and effective_cache_size</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <h3>default_statistics_target</h3>
      <p>Sets the default statistics target for table columns without a column-specific target set via ALTER TABLE SET STATISTICS. Larger values increase the time needed to do ANALYZE, but might improve the quality of the planner's estimates.</p>
      <h3>effective_cache_size</h3>
      <p>Sets the planner's assumption about the effective size of the disk cache that is available to a single query. This is factored into estimates of the cost of using an index; a higher value makes it more likely index scans will be used, a lower value makes it more likely sequential scans will be used.</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>PgTune</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <div class="centered">
        <h3><a href="http://pgtune.leopard.in.ua/">pgtune.leopard.in.ua</a></h3>
        <img src="images/pgtune.png" alt="Pgtune" style="height: 400px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Filesystem and swap</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <ul>
        <li>barrier=0, noatime</li>
        <li>xfs or ext4</li>
        <li>vm.swappiness = 0</li>
        <li>On large amounts of memory swap still almost useless</li>
        <li>Transfer of the transaction log on a separate disk</li>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Huge Pages (9.4+, linux only)</h2>
      <h3>PostgreSQL settings</h3>
    </hgroup>
    <article>
      <ul>
        <li>kernel with CONFIG_HUGETLBFS=y and CONFIG_HUGETLB_PAGE=y</li>
        <li>huge_pages = try|on|off (9.4+)</li>
        <li>echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</li>
        <li>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</li>
      </ul>
      <pre class="prettyprint" data-lang="bash">
  $ head -1 /path/to/data/directory/postmaster.pid
  4170
  $ grep ^VmPeak /proc/4170/status
  VmPeak:  6490428 kB
      </pre>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Indexes</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Functional Indexes</h2>
      <h3>Functional and Partial Indexes</h3>
    </hgroup>
    <article>
      <p>Index on expression</p>
      <pre class="prettyprint" data-lang="sql">
        CREATE INDEX foo_name_first_idx
        ON foo <b>((lower(substr(foo_name, 1, 1))));</b>
      </pre>
      <p>for selects</p>
      <pre class="prettyprint" data-lang="sql">
        SELECT * FROM foo
        <b>WHERE lower(substr(foo_name, 1, 1)) = 's';</b>
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Partial Indexes</h2>
      <h3>Functional and Partial Indexes</h3>
    </hgroup>
    <article>
      <p>Index refers to the predicate WHERE</p>
      <pre class="prettyprint" data-lang="sql">
        CREATE INDEX access_log_client_ip_ix ON access_log (client_ip)
        <b>WHERE (client_ip > inet '192.168.100.0' AND
                   client_ip < inet '192.168.100.255');</b>
      </pre>
      <p>for selects</p>
      <pre class="prettyprint" data-lang="sql">
        SELECT * FROM access_log
        <b>WHERE client_ip = '192.168.100.45';</b>
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Create Index Concurrently</h2>
      <h3>Indexes</h3>
    </hgroup>
    <article>
      <p>Instead</p>
      <pre class="prettyprint" data-lang="sql">
        CREATE INDEX sales_quantity_index ON sales_table (quantity);
      </pre>
      <p>this better for huge table</p>
      <pre class="prettyprint" data-lang="sql">
        CREATE INDEX <b>CONCURRENTLY</b> sales_quantity_index ON sales_table (quantity);
      </pre>
      <p>but be careful</p>
      <pre class="prettyprint" data-lang="sql">
        Indexes:
            "idx" btree (col) <b>INVALID</b>
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>REINDEX</h2>
      <h3>Indexes</h3>
    </hgroup>
    <article>
      <p>REINDEX rebuilds an index using the data stored in the index's table, replacing the old copy of the index</p>
      <ul>
        <li>An index has become corrupted, and no longer contains valid data. Although in theory this should never happen, in practice indexes can become corrupted due to software bugs or hardware failures</li>
        <li>An index has become "bloated", that it is contains many empty or nearly-empty pages. This can occur with B-tree indexes in PostgreSQL under certain uncommon access patterns</li>
        <li>An index build with the CONCURRENTLY option failed, leaving an "invalid" index</li>
      </ul>
      <p>REINDEX is similar to a drop and recreate of the index in that the index contents are rebuilt from scratch</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Flexible Indexes</h2>
    </hgroup>
    <article>
      <div class="centered">
        <table>
          <tbody>
            <tr>
              <th></th>
              <th>MySQL</th>
              <th>PostgreSQL</th>
              <th>MS SQL</th>
              <th>Oracle</th>
            </tr>
            <tr>
              <th>B-Tree index</th>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
            </tr>
            <tr>
              <th>Spatial indexes</th>
              <td>R-Tree</td>
              <td>Rtree_GiST</td>
              <td>Grid-based spatial index</td>
              <td>R-Tree, Quadtree</td>
            </tr>
            <tr>
              <th>Hash index</th>
              <td>Only in memory tables</td>
              <td class="highlight">Yes</td>
              <td>No</td>
              <td>No</td>
            </tr>
            <tr>
              <th>Bitmap index</th>
              <td>No</td>
              <td class="highlight">Yes</td>
              <td>No</td>
              <td class="highlight">Yes</td>
            </tr>
            <tr>
              <th>Reverse index</th>
              <td>No</td>
              <td>No</td>
              <td>No</td>
              <td class="highlight">Yes</td>
            </tr>
            <tr>
              <th>Inverted index</th>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
            </tr>
            <tr>
              <th>Partial index</th>
              <td>No</td>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
              <td>No</td>
            </tr>
            <tr>
              <th>Function based index</th>
              <td>No</td>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
              <td class="highlight">Yes</td>
            </tr>
          </tbody>
        </table>
      </div>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Table Inheritance</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Vertical and Horizontal Scaling</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/scaling_vertical.png" alt="Vertical scaling" style="width: 250px">
        </div>
        <div class="centered">
          <img src="images/scaling_horizontal.png" alt="Horizontal Scaling" style="width: 450px">
        </div>
      </div>
    </article>
  </slide>

  <slide class="segue dark quote nobackground">
    <aside class="gdbar right bottom"><img src="images/db-icon.png"></aside>
    <article class="flexbox vleft auto-fadein">
      <q>Buying a bigger box is quick(ish). Redesigning software is not.</q>
      <div class="author">
        Cal Henderson<br>
        Flickr
      </div>
    </article>
  </slide>

  <slide class="segue dark quote nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <article class="flexbox vleft auto-fadein">
      <q>37 Signals Basecamp upgraded to 128 GB DB server: don’t need to pay the complexity tax yet</q>
      <div class="author">
        David Heinemeier Hansson<br>
        Ruby on Rails
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>How to use Partitioning</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        CREATE TABLE my_logs(
          id SERIAL PRIMARY KEY,
          logdate TIMESTAMP NOT NULL,
          data JSON
        );
      </pre>
      <pre class="prettyprint" data-lang="sql">
        CREATE TABLE my_logs2015m01 (
        <b>CHECK ( logdate >= DATE '2015−01−01' AND logdate < DATE '2015−02−01' )
        ) INHERITS (my_logs)</b>;
        CREATE INDEX my_logs2015m01_logdate ON my_logs2015m01 (logdate);
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Management Partition</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <p>Simple cleanup</p>
      <pre class="prettyprint" data-lang="sql">
        DROP TABLE my_logs2015m01;
      </pre>
      <p>or remove partition from partitioning</p>
      <pre class="prettyprint" data-lang="sql">
        ALTER TABLE my_logs2015m01 <b>NO INHERIT</b> my_logs;
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Management Partition</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
  CREATE OR REPLACE FUNCTION my_logs_insert_trigger()
  RETURNS TRIGGER AS $$
  BEGIN
      IF ( NEW.logdate >= DATE '2015-01-01' AND
           NEW.logdate < DATE '2015-02-01' ) THEN
          INSERT INTO my_logs2015m01 VALUES (NEW.*);
      ELSIF ( NEW.logdate >= DATE '2015-02-01' AND
              NEW.logdate < DATE '2015-03-01' ) THEN
          INSERT INTO my_logs2015m02 VALUES (NEW.*);
      ELSE
          RAISE EXCEPTION 'Date out of range.  Fix the my_logs_insert_trigger() function!';
      END IF;
      RETURN NULL;
  END;
  $$
  LANGUAGE plpgsql;
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Management Partition</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <p>Activate trigger:</p>
      <pre class="prettyprint" data-lang="sql">
  CREATE TRIGGER insert_my_logs_trigger
      BEFORE INSERT ON my_logs
      FOR EACH ROW EXECUTE PROCEDURE my_logs_insert_trigger();
      </pre>
      <p>test it:</p>
      <pre class="prettyprint" data-lang="sql">
  INSERT INTO my_logs (user_id, logdate, data, some_state) VALUES(1, '2015-01-30', 'some data', 1);
  INSERT INTO my_logs (user_id, logdate, data, some_state) VALUES(2, '2015-02-10', 'some data2', 1);
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Management Partition</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <p>Results:</p>
      <pre class="prettyprint" data-lang="sql">
  $ SELECT * FROM ONLY my_logs;
   id | user_id | logdate | data | some_state
  ----+---------+---------+------+------------
  (0 rows)

  $ SELECT * FROM my_logs;
   id | user_id |       logdate       |       data       | some_state
  ----+---------+---------------------+------------------+------------
    1 |       1 | 2015-10-30 00:00:00 | some data        |          1
    2 |       2 | 2015-02-10 00:00:00 | some data2       |          1
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>PG Partition Manager</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <p><a href="https://github.com/keithf4/pg_partman">PG Partition Manager</a></p>
      <pre class="prettyprint" data-lang="sql">
  CREATE schema test;

  CREATE TABLE test.part_test (col1 serial, col2 text, col3 timestamptz NOT NULL DEFAULT now());

  SELECT partman.create_parent('test.part_test', 'col3', 'time-static', 'daily');
      </pre>
      <p>This will turn your table into a parent table and premake 4 future partitions and also make 4 past partitions. To make new partitions for time-based partitioning, use the run_maintenance() function. </p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Smart Query Optimization</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
  $ SET constraint_exclusion = partition;
  $ EXPLAIN SELECT ∗ FROM my_logs WHERE logdate > '2012−08−01';
                            QUERY PLAN
  −−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
  Result ( cost =6.81..41.87 rows=660 width=52)
    −> Append ( cost =6.81..41.87 rows=660 width=52)
      −> Bitmap Heap Scan on <b>my_logs</b> ( cost =6.81..20.93 rows=330 width=52)
        Recheck Cond: ( logdate > '2012−08−01 00:00:00' : : timestamp without time zone)
          −> Bitmap Index Scan on <b>my_logs_logdate</b> ( cost =0.00..6.73 rows=330 width=0)
            Index Cond: (logdate > '2012−08−01 00:00:00' : : timestamp without time zone)
      −> Bitmap Heap Scan on <b>my_logs2012m08</b> my_logs ( cost =6.81..20.93 rows=330 width=52)
        Recheck Cond: ( logdate > '2012−08−01 00:00:00' : : timestamp without time zone)
          −> Bitmap Index Scan on <b>my_logs2012m08_logdate</b> ( cost =0.00..6.73 rows=330 width=0)
            Index Cond: (logdate > '2010−08−01 00:00:00' : : timestamp without time zone)
  (10 rows)
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Caveats</h2>
      <h3>Partitioning</h3>
    </hgroup>
    <article>
      <ul>
        <li>There is no automatic way to verify that all of the CHECK constraints are mutually exclusive</li>
        <li>The schemes shown here assume that the partition key column(s) of a row never change, or at least do not change enough to require it to move to another partition</li>
        <li>If you are using manual VACUUM or ANALYZE commands, don't forget that you need to run them on each partition individually</li>
        <li>All constraints on all partitions of the master table are examined during constraint exclusion, so large numbers of partitions are likely to increase query planning time considerably. Partitioning using these techniques will work well with up to perhaps a hundred partitions; don't try to use many thousands of partitions</li>
      </ul>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Replication</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Replication Solutions</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <ul>
          <li>Streaming Replication (build in)</li>
          <li>Slony-I</li>
          <li>Pgpool-I/II</li>
          <li>Bucardo</li>
          <li>Londiste</li>
          <li>RubyRep</li>
          <li>many others...</li>
        </ul>
        <div class="centered">
          <img src="images/homer_clones.png" alt="Homer" style="width: 400px" />
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Streaming Replication</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/streamin_replication.png" alt="PostgreSQL" style="width: 400px" />
          <br />
          <br />
          <br />
        </div>
        <ul>
          <li>Advantages:
            <ul>
              <li>Log-shipping instead triggers</li>
              <li>Multiple standbys</li>
              <li>Synchronous and asynchronous</li>
              <li>Continuous recovery</li>
              <li>Easy monitoring</li>
            </ul>
          </li>
          <li>Disadvantages:
            <ul>
              <li>You can replicate only full database</li>
              <li>Replication beyond timeline</li>
              <li><b>No failover and load balancing</b></li>
            </ul>
          </li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>The history of replication in PostgreSQL</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div>
        <ul>
          <li><b>2001</b>: PostgreSQL 7.1: write-ahead log</li>
          <li><b>2004</b>: Slony</li>
          <li><b>2005</b>: PostgreSQL 8.0: point-in-time recovery</li>
          <li><b>2008</b>: PostgreSQL 8.3: pg_standby</li>
          <li><b>2010</b>: PostgreSQL 9.0: hot standby, streaming replication</li>
          <li><b>2011</b>: PostgreSQL 9.1: pg_basebackup, synchronous replication</li>
          <li><b>2012</b>: PostgreSQL 9.2: cascading replication</li>
          <li><b>2013</b>: PostgreSQL 9.3: standby can follow timeline switch</li>
          <li><b>2014</b>: PostgreSQL 9.4: replication slots, logical decoding</li>
          <li><b>2015</b>? PostgreSQL 9.5? pg_rewind?</li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Slony-I</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/slony.jpg" alt="PostgreSQL" style="width: 400px" />
          <br />
          <br />
          <br />
          <br />
          <br />
        </div>
        <ul>
          <li>Advantages:
            <ul>
              <li>Replicate between different version of databases</li>
              <li>Replicate part of tables in database</li>
              <li>Extra behaviours taking place on subscribers, for instance, populating cache management information</li>
            </ul>
          </li>
          <li>Disadvantages:
            <ul>
              <li>Trigger replication</li>
              <li>You're probably okay. Until slony breaks :)</li>
            </ul>
          </li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Pgpool-I/II</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/pgpool.jpg" alt="PostgreSQL" style="width: 400px" />
          <br />
          <br />
          <br />
          <br />
          <br />
        </div>
        <ul>
          <li>Advantages:
            <ul>
              <li>Simple setup</li>
              <li>Have additional features (Connection Pooling, Load Balancing, Limiting Exceeding Connections, Parallel Query)</li>
            </ul>
          </li>
          <li>Disadvantages:
            <ul>
              <li>Synchronous replication (more nodes - bigger slowdown)</li>
            </ul>
          </li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Bucardo</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/bucardo.jpg" alt="PostgreSQL" style="width: 400px" />
        </div>
        <ul>
          <li>Advantages:
            <ul>
              <li>Master-master of Master-slave replication</li>
              <li>Replicate between different version of databases</li>
              <li>Replicate part of tables in database</li>
              <li>Replicate to different databases (drizzle, mongo, mysql, oracle, redis and sqlite)</li>
            </ul>
          </li>
          <li>Disadvantages:
            <ul>
              <li>Trigger replication</li>
            </ul>
          </li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Londiste</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/londiste.png" alt="PostgreSQL" style="width: 400px" />
          <br />
          <br />
          <br />
          <br />
          <br />
        </div>
        <ul>
          <li>Advantages:
            <ul>
              <li>Replicate between different version of databases</li>
              <li>Replicate part of tables in database</li>
              <li>Simple setup and monitoring</li>
            </ul>
          </li>
          <li>Disadvantages:
            <ul>
              <li>Trigger replication</li>
            </ul>
          </li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Bi-Directional Replication (BDR)</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/BDR.png" alt="PostgreSQL" style="width: 400px" />
        </div>
        <ul>
          <li>Advantages:
            <ul>
              <li>Master-master replication</li>
              <li>Up to 48 nodes</li>
            </ul>
          </li>
          <li>Disadvantages:
            <ul>
              <li>Conflict Resolution</li>
              <li>Each node eventually consistent</li>
              <li>Right now we have only patch, official should be for 9.5</li>
            </ul>
          </li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Replication comparison</h2>
    </hgroup>
    <article class="smaller">
      <table>
        <tbody>
          <tr>
            <td></td>
            <th>Hot Standby</th>
            <th>BDR</th>
            <th>Londiste</th>
            <th>Slony</th>
            <th>Bucardo</th>
          </tr>
          <tr>
            <th>Multi-Master</th>
            <td>No</td>
            <td>Yes</td>
            <td>No<sup style="vertical-align: super; font-size: smaller;">1</sup></td>
            <td>No</td>
            <td>Yes</td>
          </tr>
          <tr>
            <th>Per DB Replication</th>
            <td>No</td>
            <td>Yes</td>
            <td>Yes</td>
            <td>Yes</td>
            <td>Yes</td>
          </tr>
          <tr>
            <th>Cascading</th>
            <td>Yes</td>
            <td>No</td>
            <td>Yes</td>
            <td>Yes</td>
            <td>Yes</td>
          </tr>
          <tr>
            <th>DDL Replication</th>
            <td>Yes</td>
            <td>Yes</td>
            <td>No<sup style="vertical-align: super; font-size: smaller;">2</sup></td>
            <td>No<sup style="vertical-align: super; font-size: smaller;">2</sup></td>
            <td>No</td>
          </tr>
          <tr>
            <th>Need external daemon</th>
            <td>No</td>
            <td>No</td>
            <td>Yes</td>
            <td>Yes</td>
            <td>Yes</td>
          </tr>
          <tr>
            <th>New table added automatically</th>
            <td>Yes</td>
            <td>Yes</td>
            <td>No</td>
            <td>No</td>
            <td>No</td>
          </tr>
          <tr>
            <th>Use triggers</th>
            <td>No</td>
            <td>No</td>
            <td>Yes</td>
            <td>Yes</td>
            <td>Yes</td>
          </tr>
          <tr>
            <th>Support updates on PK columns</th>
            <td>Yes</td>
            <td>Yes</td>
            <td>No</td>
            <td>No</td>
            <td>No</td>
          </tr>
          <tr>
            <th>Selective replication</th>
            <td>No</td>
            <td>Yes</td>
            <td>Yes</td>
            <td>Yes</td>
            <td>Yes</td>
          </tr>
          <tr>
            <th>Transactions applied indidualy</th>
            <td>Yes</td>
            <td>Yes</td>
            <td>No</td>
            <td>No</td>
            <td>No</td>
          </tr>
        </tbody>
      </table>
      <p style="font-size: 0.9rem">1 - Multi-master via handler, but only supports last update wins conflict resolution and is complicated</p>
      <p style="font-size: 0.9rem">2 - Londiste and Slony provide facilities for executing scripts on all nodes but it's not transparent</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Pgpool-II + Streaming Replication = &lt;3</h2>
      <h3>Replication</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <ul>
          <li>Ease of setup and maintenance</li>
          <li>Adding slaves without sacrificing performance</li>
          <li>More slaves - more performance on reading (load balancing)</li>
          <li>Automatic switch to slave if master fail (failover)</li>
        </ul>
        <div class="centered">
          <img src="images/pgpool.png" alt="pgpool" style="width: 300px" />
        </div>
      </div>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Clustering</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Clustering solutions</h2>
      <h3>Clustering</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <ul>
          <li>Pl/Proxy (SkyTools)</li>
          <li>Postgres-XC, Postgres-XL</li>
          <li>Pg_shard</li>
          <li>Stado (sequel to GridSQL)</li>
          <li>Greenplum</li>
        </ul>
        <div class="centered">
          <img src="images/scaling_horizontal.png" alt="Horizontal Scaling" style="width: 400px">
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Pl/Proxy</h2>
      <h3>Clustering</h3>
    </hgroup>
    <article class="smaller">
      <pre class="prettyprint" data-lang="sql">

  CREATE OR REPLACE FUNCTION
  public.get_cluster_partitions(cluster_name text)
    RETURNS SETOF text AS
  $BODY$
  BEGIN
    IF cluster_name = 'usercluster' THEN
      RETURN NEXT 'dbname=plproxytest host=node1 user=postgres';
      RETURN NEXT 'dbname=plproxytest host=node2 user=postgres';
      RETURN;
    END IF;
    RAISE EXCEPTION 'Unknown cluster';
  END;
  $BODY$
    LANGUAGE 'plpgsql' VOLATILE
    COST 100
    ROWS 1000;
  ALTER FUNCTION public.get_cluster_partitions(text)
  OWNER TO postgres;

      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Postgres-XC</h2>
      <h3>Clustering</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <ul>
          <li>Write‐scalable PostgreSQL cluster (more than 3x scalability performance speedup with five servers, compared with pure PostgreSQL)</li>
          <li>Synchronous multi‐master configuration (any update to any master is visible from other masters immediately)</li>
          <li>Table location transparent</li>
          <li>Based upon PostgreSQL</li>
          <li>Same API to Apps as PostgreSQL</li>
        </ul>
        <div class="centered">
          <img src="images/Postgers_XC.jpg" alt="postgres-xc" style="width: 400px" />
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Postgres-XC</h2>
      <h3>Clustering</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/postgres-xc-02.png" alt="postgres-xc" style="height: 450px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Pg_shard</h2>
      <h3>Clustering</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">

  CREATE EXTENSION pg_shard;

  CREATE TABLE customer_reviews
  (
      customer_id TEXT NOT NULL,
      review_date DATE,
      review_rating INTEGER
  );


  SELECT master_create_distributed_table('customer_reviews', 'customer_id');

  SELECT master_create_worker_shards('customer_reviews', 16, 2);

      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Pg_shard Limitations</h2>
      <h3>Clustering</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <h3>Architectural decisions:</h3>
        <ul>
          <li>Transactional semantics for queries that span across multiple shards. For example, you're a financial institution and you sharded your data based on customer_id. You'd now like to withdraw money from one customer's account and debit it to another one's account, in a single transaction block</li>
          <li>Unique constraints on columns other than the partition key, or foreign key constraints</li>
          <li>Distributed "JOIN"s also aren't supported</li>
        </ul>
        <h3>Unsupported features:</h3>
        <ul>
          <li>Table alterations are not supported: customers who do need table alterations accomplish them by using a script that propagates such changes to all worker nodes</li>
          <li>"DROP TABLE" does not have any special semantics when used on a distributed table. An upcoming release will add a shard cleanup command to aid in removing shard objects from worker nodes</li>
          <li>Queries such as "INSERT INTO foo SELECT bar, baz FROM qux" are not supported</li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Radical Additional Options</h2>
      <h3>Clustering</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <p>"NoSQL" database</p>
          <ul>
            <li>CouchDB, MongoDB, HBase, Cassandra, Redis</li>
            <li>Document store</li>
            <li>Map/Reduce querying</li>
          </ul>
        </div>
        <div class="centered">
          <img src="images/nosql-logos.png" alt="NoSQL" style="width: 450px">
        </div>
      </div>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Extensions</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>Foreign Data Wrappers (FDWs)</h2>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/fdws.png" alt="FDWs" style="width: 600px" />
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Wrappers</h2>
      <h3>Foreign Data Wrappers (FDWs)</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <ul>
          <li>oracle_fdw</li>
          <li>mysql_fdw</li>
          <li>odbc_fdw</li>
          <li>jdbc_fdw</li>
          <li>couchdb_fdw</li>
          <li>mongo_fdw</li>
          <li>redis_fdw</li>
          <li>file_fdw, file_text_array_fdw, file_fixed_length_record_fdw</li>
          <li>twitter_fdw</li>
          <li>ldap_fdw</li>
          <li>s3_fdw</li>
          <li>www_fdw</li>
          <li>Multicorn (CSV, FS, RSS, Hive)</li>
        </ul>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Wrappers support</h2>
      <h3>Foreign Data Wrappers (FDWs)</h3>
    </hgroup>
    <article>
      <ul>
        <li>From PostgreSQL 9.1 - wrappers can only read</li>
        <li>From PostgreSQL 9.3 - wrappers can read and write</li>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Contrib Extensions</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <ul>
            <li>Dblink</li>
            <li>Cube</li>
            <li>Fuzzystrmatch</li>
            <li>Hstore</li>
            <li>Intarray</li>
            <li>Ltree</li>
            <li>Pg_buffercache</li>
            <li>Pgbench</li>
            <li>Uuid-ossp</li>
            <li>Tsearch2</li>
            <li>many others...</li>
          </ul>
        </div>
        <div class="centered">
          <img src="images/extensions.png" alt="Extensions" style="width: 460px" />
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>PostGIS and PgSphere</h2>
      <h3>Extensions</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <p>PostGIS adds support for geographic objects to the PostgreSQL. PostGIS corresponds OpenGIS and has been certified</p>
          <p>PgSphere provides spherical PostgreSQL data types, as well as functions and operators to work with them. Used to work with geographic (can be used instead of PostGIS) or astronomical data types</p>
        </div>
        <div class="centered">
          <img src="images/postgis.png" alt="Extensions" style="width: 460px" />
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>PLV8</h2>
      <h3>Extensions</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <p>PLV8 is an extension that provides PostgreSQL procedural language with the V8 JavaScript engine</p>
          <p>Why javascript?</p>
          <ul>
            <li>everywhere</li>
            <li>good parts</li>
            <li>trusted language</li>
          </ul>
        </div>
        <div class="centered">
          <img src="images/v8.png" alt="Extensions" style="width: 460px" />
        </div>
      </div>
    </article>
  </slide>


  <slide>
    <hgroup>
      <h2>Fibonacci</h2>
      <h3>PLV8</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <pre class="prettyprint" data-lang="sql">

        CREATE OR REPLACE FUNCTION
        psqlfib(n int) RETURNS int AS $$
         BEGIN
             IF n < 2 THEN
                 RETURN n;
             END IF;
             RETURN psqlfib(n-1) + psqlfib(n-2);
         END;
        $$ <b>LANGUAGE plpgsql</b> IMMUTABLE STRICT;

          </pre>
          <br />
          <br />
          <br />
        </div>
        <div>
          <pre class="prettyprint" data-lang="sql">
            select n, psqlfib(n)
            from generate_series(0,30,5) as n;
               n  | psqlfib
              ----+---------
                0 |       0
                5 |       5
               10 |      55
               15 |     610
               20 |    6765
               25 |   75025
               30 |  832040
              (7 rows)

              <b>Time: 34014.299 ms</b>
          </pre>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Fibonacci</h2>
      <h3>PLV8</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <pre class="prettyprint" data-lang="sql">

        CREATE OR REPLACE FUNCTION
        fib(n int) RETURNS int as $$

          function fib(n) {
            return n<2 ? n : fib(n-1) + fib(n-2)
          }
          return fib(n)

        $$ <b>LANGUAGE plv8</b> IMMUTABLE STRICT;

          </pre>
          <br />
          <br />
          <br />
        </div>
        <div>
          <pre class="prettyprint" data-lang="sql">
            select n, fib(n)
            from generate_series(0,30,5) as n;
               n  |  fib
              ----+--------
                0 |      0
                5 |      5
               10 |     55
               15 |    610
               20 |   6765
               25 |  75025
               30 | 832040
              (7 rows)

              <b>Time: 33.430 ms</b>
          </pre>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Fibonacci (with cache in js object)</h2>
      <h3>PLV8</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <pre class="prettyprint" data-lang="sql">
        CREATE OR REPLACE FUNCTION
        fib2(n int) RETURNS int as $$

          var memo = {0: 0, 1: 1}
          function fib(n) {
            if(!(n in memo))
              memo[n] = fib(n-1) + fib(n-2)
            return memo[n]
          }
          return fib(n);

        $$ <b>LANGUAGE plv8</b> IMMUTABLE STRICT;
          </pre>
          <br />
          <br />
          <br />
          <br />
        </div>
        <div>
          <pre class="prettyprint" data-lang="sql">
            select n, fib2(n)
            from generate_series(0,30,5) as n;
               n  |  fib2
              ----+--------
                0 |      0
                5 |      5
               10 |     55
               15 |    610
               20 |   6765
               25 |  75025
               30 | 832040
              (7 rows)

              <b>Time: 0.535 ms</b>
          </pre>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Mustache.js in PostgreSQL</h2>
      <h3>plv8</h3>
    </hgroup>
    <article>
      <div class="centered">
        <img src="images/mustache.jpeg" alt="Mustache" style="width: 400px" />
      </div>
      <div class="centered">Logic-less templates.</div>
      <div class="centered"><a href="http://mustache.github.com">mustache.github.com</a></div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Mustache.js in PostgreSQL</h2>
      <h3>plv8</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="sql">
        create or replace function mustache(template text, view json)
        returns text as $$
          // …400 lines of mustache.js…
          return Mustache.to_html(template, JSON.parse(view))
        $$ LANGUAGE plv8 IMMUTABLE STRICT;
      </pre>
      <pre class="prettyprint" data-lang="sql">
        select mustache(
          'hello {{#things}}{{.}} {{/things}}:) {{#data}}{{key}}{{/data}}',
          '{"things": ["world", "from", "postgresql"], "data": {"key": "and me"}}'
        );
                         mustache
          ---------------------------------------
           hello world from postgresql :) and me
          (1 row)

          Time: 0.837 ms
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Ltree</h2>
      <h3>Extensions</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <p>Ways to store tree in RDBMS:</p>
          <ul>
            <li>Parent-child</li>
            <li>Materialized Path</li>
            <li>Nested Sets</li>
          </ul>
        </div>
        <div>
          <p>Ltree - an extension that allows you to store tree structures in the form of tags, as well as providing opportunities to find them</p>
          <ul>
            <li>Implementation of the algorithm Materialized Path (fast enough as to write and read)</li>
            <li>Usually the decision will be faster than using the CTE (Common Table Expressions) or a recursive function (constantly be recalculated branch)</li>
            <li>Integrated search mechanisms</li>
            <li>Indexes</li>
          </ul>
        </div>
      </div>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Another list of good extensions</h2>
      <h3>Extensions</h3>
    </hgroup>
    <article>
      <div class="columns-2">
        <div>
          <ul>
            <li>PostPic</li>
            <li>Pg_repack</li>
            <li>Smlar</li>
            <li>Pgaudit</li>
            <li>Texcaller</li>
            <li>PgMemcache</li>
            <li>Prefix</li>
            <li>Pgloader</li>
            <li>Cstore_fdw</li>
            <li>Pg_shard</li>
          </ul>
        </div>
        <div class="centered">
          <img src="images/extensions.png" alt="Extensions" style="width: 460px" />
        </div>
      </div>
    </article>
  </slide>

  <slide class="segue dark nobackground">
    <aside class="gdbar"><img src="images/db-icon.png"></aside>
    <hgroup class="auto-fadein">
      <h2>Backup and restore</h2>
      <h3></h3>
    </hgroup>
  </slide>

  <slide>
    <hgroup>
      <h2>SQL backup</h2>
      <h3>Backup and restore</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="bash">
    $ pg_dump dbname > outfile
      </pre>
      <pre class="prettyprint" data-lang="bash">
    $ psql dbname < infile
      </pre>
      <pre class="prettyprint" data-lang="bash">
    $ pg_dump -h host1 dbname | psql -h host2 dbname
      </pre>
      <pre class="prettyprint" data-lang="bash">
    $ pg_dumpall > outfile
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>SQL backup of a big databases (use gzip)</h2>
      <h3>SQL backup</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="bash">
    $ pg_dump dbname | gzip > filename.gz
      </pre>
      <pre class="prettyprint" data-lang="bash">
    $ gunzip -c filename.gz | psql dbname
      </pre>
      <pre class="prettyprint" data-lang="bash">
    $ cat filename.gz | gunzip | psql dbname
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>SQL backup of a big databases (use split)</h2>
      <h3>SQL backup</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="bash">
    $ pg_dump dbname | split -b 1m - filename
      </pre>
      <pre class="prettyprint" data-lang="bash">
    $ cat filename* | psql dbname
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>SQL backup of a big databases (use build-in Zlib)</h2>
      <h3>SQL backup</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="bash">
    $ pg_dump -Fc dbname > filename
      </pre>
      <pre class="prettyprint" data-lang="bash">
    $ pg_restore -d dbname filename
      </pre>
      <p>tables can be selectively recovered</p>
      <pre class="prettyprint" data-lang="bash">
    $ pg_restore -d dbname -t users -t companies filename
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>File system backup</h2>
      <h3>Backup and restore</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="bash">
    $ tar -cf backup.tar /usr/local/pgsql/data
      </pre>
      <p>But there are two restrictions, which makes this method impractical</p>
      <ul>
        <li>PostgreSQL database must be stopped in order to get the current backup. During the restoration of the backup will also need to stop PostgreSQL</li>
        <li>Do not get restore only certain data from this backup</li>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>File system backup</h2>
      <h3>Backup and restore</h3>
    </hgroup>
    <article>
      <p>Working variants</p>
      <ul>
        <li>Filesystem snapshots (if the file system PostgreSQL is distributed on different file systems, then this method will be very unreliable)</li>
        <li>Rsync working database and after this rsync stopped database. The second run rsync pass much faster than the first</li>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Continuous Archiving</h2>
      <h3>Backup and restore</h3>
    </hgroup>
    <article>
      <p>This approach is more difficult to setup than any of the previous approach, but it has some advantages:</p>
      <ul>
        <li>No need to coordinate the system backup files. Any internal inconsistency in the backup will be corrected by wal log replay (no different from what happens during crash recovery)</li>
        <li>Point-in-Time Recovery (PITR)</li>
        <li>If we will constantly "feed" WAL files to another machine that has been loaded with the same files standby database, then we will be being always up to date backup server PostgreSQL (creation of hot standby server)</li>
      </ul>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Continuous Archiving</h2>
      <h3>Backup and restore</h3>
    </hgroup>
    <article>
      <pre class="prettyprint" data-lang="bash">
    archive_mode = on # enable archiving
    archive_command = 'cp -v %p /data/pgsql/archives/%f'
    archive_timeout = 300 # timeout to close buffers
      </pre>
      <pre class="prettyprint" data-lang="bash">
    $ rsync -avz --delete prod1:/data/pgsql/archives/ \
    /data/pgsql/archives/ > /dev/null
      </pre>
      <pre class="prettyprint" data-lang="bash">
    restore_command = 'cp /data/pgsql/archives/%f "%p"'
      </pre>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>WAL-E and Barman</h2>
      <h3>Continuous Archiving</h3>
    </hgroup>
    <article>
      <p>WAL-E is designed for continuous backup PostgreSQL WAL-logs in Amazon S3 or Windows Azure (since version 0.7) and management and pg_start_backup pg_stop_backup. Utility written in Python and is designed in the company Heroku, where it is actively used</p>
      <p>Barman, as WAL-E, allows you to create a system backup and restore PostgreSQL-based continuous backup. Barman uses to store backups separate server that can collect as backups from one or from multiple PostgreSQL databases</p>
    </article>
  </slide>

  <slide>
    <hgroup>
      <h2>Scaling strategy for PostgreSQL</h2>
    </hgroup>
    <article>
      <div class="columns-2">
        <div class="centered">
          <img src="images/alex.gif" alt="Scaling strategy" style="width: 460px" />
        </div>
        <div>
          <ul>
            <li>Bandwidth limitation of data reading;</li>
            <li>Bandwidth limitation of data recording;</li>
          </ul>
        </div>
      </div>
    </article>
  </slide>

  <slide class="thank-you-slide segue dark nobackground">
    <aside class="gdbar right"><img src="images/db-icon.png"></aside>
    <article class="flexbox vleft auto-fadein">
      <h2>&lt;Thank You!&gt;</h2>
      <p>Contact information</p>
    </article>
    <p class="auto-fadein" data-config-contact>
      <!-- populated from slide_config.json -->
    </p>
  </slide>

  <slide class="backdrop"></slide>

</slides>

<!--[if IE]>
  <script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->
</body>
</html>
